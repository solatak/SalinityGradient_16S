---
title: "Phyloseq Preprocessing"
author: "Sola Takahashi"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup}
knitr::opts_chunk$set(echo = TRUE, 
                      fig.align = "center",
                      fig.path = "../figures/02_PreProcessing/") # send any figure output to this folder
```


# Load Libraries 
```{r load-libraries}

library(devtools)
#devtools::install_github("joey711/phyloseq")
library(phyloseq)
library(tidyverse)

```

# Goals: 
Here we will process the data into a phyloseq object.

- ASV Table
- Taxonomy Table
- Track reads (metadata)

Then, we will remove the following: 

1. Remove Chloroplasts
2. Remove Mitochondria
3. Remove samples without enough reads

Finally, write a data file of phyloseq output. 


# Load Data 

## ASV Table
```{r load-asv-table}
# first we will load asv table 
load("data/01_DADA2/ASV_counts.RData")

#Inspect ASV tab
head(asv_tab)[,1:5]

# Fix names
sample_names <- colnames(asv_tab)
samples_fixed <- sapply(strsplit(basename(sample_names), "_"), `[`,1) 
head(samples_fixed)

# Re-write the ASV count file to fix names 
colnames(asv_tab) <- samples_fixed
str(asv_tab)

```


## Taxonomy Table
```{r load-tax-table}
tax_df <- read.table("data/01_DADA2/ASV_taxonomy.tsv", sep = "\t", skip = 1)
head(tax_df)

# fix column names
colnames(tax_df) <- c("asv_names", "Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "ASV", "ASVseq")
head(tax_df)

# Taxonomy Table Matrix
tax_mat <-
  tax_df %>% 
  tibble::column_to_rownames(., var = "asv_names") %>% 
  as.matrix()

```


## Track Reads Data
```{r load-track-reads}
load("data/01_DADA2/track_read_counts.RData")

# take a look at the data
head(track_counts_df)
dim(track_counts_df)

# Please in the terminal, copy the metadata.csv
# Into SalinityGradient_16S/ data
# from: /workdir/in_class_data/SalinityGradient_16S/
# scp /workdir/in_class_data/SalinityGradient_16S/metadata.csv  /workdir/st974/git_repo/SalinityGradient_16S/data/

# Load in the metadata
metadata_df <- read.csv("data/metadata.csv")
head (metadata_df)
dim(metadata_df)
# have 95 samples 
head(track_counts_df)

#check column names
colnames(metadata_df)

# Merge metadata_df with track_reads_df
metadata_track_reads_df <- metadata_df %>%
  left_join(., track_counts_df, by = "names") %>%
  dplyr::select(-X)

# Intuition check
head(metadata_track_reads_df)

# Update row.names to be sample names
# Before
row.names(metadata_track_reads_df)
# Rewrite
row.names(metadata_track_reads_df) <- metadata_track_reads_df$names
# Check if it worked
row.names(metadata_track_reads_df)

# Intuition Check 
head(metadata_track_reads_df)

```


# Handoff to Phyloseq
```{r phyloseq-handoff}
# Double check it's all good
dim(asv_tab) # count table
dim(tax_mat) # taxonomy matrix
# rows match

# Intuition Check
stopifnot(row.names(asv_tab) == row.names(tax_mat))
# no output = happy

# Construct the phyloseq object
raw_physeq <- phyloseq(otu_table(asv_tab, taxa_are_rows = TRUE), 
                       sample_data(metadata_track_reads_df),
                       tax_table(tax_mat))
raw_physeq

# Save this raw phyloseq object
save(raw_physeq, file = "data/02_PreProcessing/raw_physeq.RData")
```

# Clean up the data

Remove:

1. Chloroplasts
2. Mitochondria

```{r rm-mitos-chloros} 
# Remind myself of tax table
#view(tax_mat)

# Make a new physeq without chloroplasts
noChloros_physeq <- 
  raw_physeq %>%
  # rm chloroplasts
  subset_taxa(Order != "Chloroplast" | is.na(Order))
# is.na prevents over loss

# How many taxa were chloroplasts?
num_chloro_ASVs <- ntaxa(raw_physeq) - ntaxa(noChloros_physeq)
num_chloro_ASVs

# Intuition Check
#noChloros_physeq%>%
#  tax_table() %>%
#  data.frame() %>%
#  view()

# Remove Mitochondria
noChlorosMitos_physeq <- 
  noChloros_physeq %>%
  subset_taxa(Family != "Mitochondria" | is.na(Family))

# How many mitochondrial ASVs
num_mito_ASVs <- ntaxa(noChloros_physeq) - ntaxa(noChlorosMitos_physeq)
num_mito_ASVs

# How many total ASVs were removed from Chloro and Mitos?
ntaxa(raw_physeq) - ntaxa(noChlorosMitos_physeq)
# Proportions of ASVs
ntaxa(noChlorosMitos_physeq)/ntaxa(raw_physeq)
# lost about 12% of ASVs
```

# Evaluate and remove the control samples 

Take a look at the negative controls and then make a decision about whether or not to remove the ASVs found in our controls 

1. Negative Controls
2. ASVs found within the negative controls and their distribution in the samples.
3. Evaluate the mock community

```{r neg-controls} 
# Create a vector of samples that were negative controls
control_samples <- c("WaterControl", "022um-Control", 
                     "3um-Control", "DNA-Ext-Control")

# Make a new phyloseq object of only the control samples 
control_physeq <- 
  noChlorosMitos_physeq %>%
  subset_samples(., names %in% control_samples) %>%
  # force remove ASVs with 0 counts
  prune_taxa(taxa_sums(.) > 0, .)

control_physeq

# Vector of Control ASVs
control_ASVs <-
  control_physeq %>%
  tax_table() %>%
  data.frame() %>%
  dplyr::select(ASV) %>%
  as.vector()

# Visualize raw abundance values of control ASVs
control_physeq %>%
  plot_bar(., "ASV", fill = "ASV")
# ASV_3 is really abundant 
# the third most abundant ASV is found in negative control...

############# Check the control ASVs in the samples
# Make a new phyloseq object with only the control ASVs and ALL samples 
controlASV_physeq <- 
  noChlorosMitos_physeq %>%
  subset_taxa(., ASV %in% control_ASVs$ASV)

# Inspect it 
controlASV_physeq

# Let's take a look at the abundances
controlASV_physeq %>%
  plot_bar(., "ASV", fill = "ASV", facet_grid = Sample_or_Control~.)
# ASV 3, 18, 56 -> somewhat abundant in the data

# Check taxa of ASV_3
#controlASV_physeq %>%
#  tax_table() %>%
#  data.frame() %>%
#  view()
# pseudomonas -> in a lot of skin/human samples
# don't keep ASV_3
# ASV_18 is actinobacteria -> not sus
# ASV_56 also not sus

# Would only like to keep ASV_18 and ASV_56, everything else is trash
controlASVs_toREMOVE <- dplyr::setdiff(control_ASVs$ASV, c("ASV_18", "ASV_56"))
length(controlASVs_toREMOVE)

noControlsChloroMitos_physeq <- 
  noChlorosMitos_physeq %>%
  #Actually remove control ASVs except 18 and 56
  subset_taxa(., !(ASV %in% controlASVs_toREMOVE)) %>%
  # Remove control samples
  subset_samples(., !(names %in% control_samples))

# Inspect no cotrols object
noControlsChloroMitos_physeq

# After filtering how many ASVs were removed
total_ASVs_rm <- ntaxa(raw_physeq) - ntaxa(noControlsChloroMitos_physeq)
total_ASVs_rm


```

# Session Information
```{r session-info}
# Ensure reproducibility
devtools::session_info()
```



